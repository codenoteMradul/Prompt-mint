<div class="mx-auto w-full max-w-3xl">
  <div class="mb-6">
    <%= link_to "â† Back to Dashboard", dashboard_path, class: "text-sm text-slate-400 hover:text-white transition-colors duration-300" %>
    <h1 class="mt-3 text-2xl font-semibold tracking-tight text-white">Sell Bundle</h1>
    <p class="mt-1 text-sm text-slate-400">Create a bundle with at least <%= Bundle::MIN_PROMPTS %> prompts.</p>
  </div>

  <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.03)] backdrop-blur">
    <%= form_with model: @bundle, data: { controller: "bundle-form", action: "submit->bundle-form#submitAttempt", bundle_form_min_value: Bundle::MIN_PROMPTS } do |form| %>
      <% if @bundle.errors.any? %>
        <div class="mb-6 rounded-2xl border border-rose-500/20 bg-rose-500/10 px-4 py-3 text-sm text-rose-100">
          <div class="font-semibold"><%= pluralize(@bundle.errors.count, "error") %> prevented this bundle from being saved:</div>
          <ul class="mt-2 list-disc pl-5 text-rose-100/90">
            <% @bundle.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-4">
        <div class="relative">
          <%= form.text_field :title, required: true, autofocus: true, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-cyan-400/40 focus:ring-4 focus:ring-cyan-400/10", placeholder: "Title" %>
          <%= form.label :title, "Title", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-cyan-200" %>
        </div>

        <div class="relative">
          <%= form.text_area :description, rows: 4, required: true, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-fuchsia-400/40 focus:ring-4 focus:ring-fuchsia-400/10", placeholder: "Description" %>
          <%= form.label :description, "Description", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-fuchsia-200" %>
        </div>

        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div class="relative">
            <%= form.select :category, Bundle.categories.keys.map { |c| [c.titleize, c] }, { include_blank: "Select category" }, required: true, class: "peer w-full appearance-none rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white outline-none transition-all duration-300 focus:border-cyan-400/40 focus:ring-4 focus:ring-cyan-400/10" %>
            <%= form.label :category, "Category", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400" %>
          </div>

          <div class="relative">
            <%= form.number_field :price, min: 0, step: 1, required: true, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-pink-400/40 focus:ring-4 focus:ring-pink-400/10", placeholder: "Price" %>
            <%= form.label :price, "Price", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-pink-200" %>
          </div>
        </div>

        <div>
          <div class="mb-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-sm font-semibold text-white">Bundle Prompts</h2>
              <p class="mt-1 text-xs text-slate-400">
                <span data-bundle-form-target="count">1</span> / <%= Bundle::MIN_PROMPTS %> prompts added (minimum required: <%= Bundle::MIN_PROMPTS %>)
              </p>
            </div>

            <div class="flex items-center gap-2">
              <button type="button" class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-medium text-slate-100 hover:bg-white/10 transition-all duration-300" data-action="bundle-form#add">
                + Add Prompt
              </button>
            </div>
          </div>

          <div class="hidden mb-3 rounded-2xl border border-amber-500/20 bg-amber-500/10 px-4 py-3 text-sm text-amber-100" data-bundle-form-target="clientError">
            Please add at least <%= Bundle::MIN_PROMPTS %> prompts before creating the bundle.
          </div>

          <div class="max-h-[32rem] overflow-y-auto rounded-2xl border border-white/10 bg-black/20 p-3" data-bundle-form-target="list">
            <% total = @bundle.prompts.size %>
            <%= form.fields_for :prompts do |prompt_fields| %>
              <div class="mb-3 last:mb-0 overflow-hidden rounded-2xl border border-white/10 bg-white/[0.03]" data-bundle-form-target="item">
                <div class="flex items-center justify-between gap-3 px-4 py-3">
                  <button type="button" class="min-w-0 flex-1 text-left" data-action="bundle-form#toggle">
                    <div class="truncate text-sm font-semibold text-white" data-bundle-form-target="titlePreview">Untitled prompt</div>
                    <div class="mt-0.5 text-xs text-slate-400">Click to expand</div>
                  </button>

                  <button
                    type="button"
                    class="rounded-xl border border-white/10 bg-white/5 px-3 py-1.5 text-xs text-slate-200 hover:bg-white/10 transition-all duration-300 disabled:opacity-40"
                    data-action="bundle-form#remove"
                    data-bundle-form-target="removeButton"
                  >
                    Remove
                  </button>
                </div>

                <%= prompt_fields.hidden_field :_destroy, value: "0", data: { bundle_form_target: "destroyField" } %>

                <div class="border-t border-white/10 overflow-hidden transition-all duration-300 max-h-0 opacity-0" data-bundle-form-target="panel">
                  <div class="px-4 py-4">
                    <div class="relative">
                      <%= prompt_fields.text_field :title, required: true, data: { action: "input->bundle-form#syncTitle" }, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-cyan-400/40 focus:ring-4 focus:ring-cyan-400/10", placeholder: "Title" %>
                      <%= prompt_fields.label :title, "Prompt title", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-cyan-200" %>
                    </div>

                    <div class="relative mt-4">
                      <%= prompt_fields.text_area :content, rows: 6, required: true, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 font-mono text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-fuchsia-400/40 focus:ring-4 focus:ring-fuchsia-400/10", placeholder: "Content" %>
                      <%= prompt_fields.label :content, "Prompt content", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-fuchsia-200" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <template data-bundle-form-target="template">
            <%= form.fields_for :prompts, Prompt.new, child_index: "NEW_RECORD" do |prompt_fields| %>
              <div class="mb-3 last:mb-0 overflow-hidden rounded-2xl border border-white/10 bg-white/[0.03]" data-bundle-form-target="item" data-new-record="true">
                <div class="flex items-center justify-between gap-3 px-4 py-3">
                  <button type="button" class="min-w-0 flex-1 text-left" data-action="bundle-form#toggle">
                    <div class="truncate text-sm font-semibold text-white" data-bundle-form-target="titlePreview">Untitled prompt</div>
                    <div class="mt-0.5 text-xs text-slate-400">Click to expand</div>
                  </button>

                  <button
                    type="button"
                    class="rounded-xl border border-white/10 bg-white/5 px-3 py-1.5 text-xs text-slate-200 hover:bg-white/10 transition-all duration-300 disabled:opacity-40"
                    data-action="bundle-form#remove"
                    data-bundle-form-target="removeButton"
                  >
                    Remove
                  </button>
                </div>

                <%= prompt_fields.hidden_field :_destroy, value: "0", data: { bundle_form_target: "destroyField" } %>

                <div class="border-t border-white/10 overflow-hidden transition-all duration-300 max-h-0 opacity-0" data-bundle-form-target="panel">
                  <div class="px-4 py-4">
                    <div class="relative">
                      <%= prompt_fields.text_field :title, required: true, data: { action: "input->bundle-form#syncTitle" }, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-cyan-400/40 focus:ring-4 focus:ring-cyan-400/10", placeholder: "Title" %>
                      <%= prompt_fields.label :title, "Prompt title", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-cyan-200" %>
                    </div>

                    <div class="relative mt-4">
                      <%= prompt_fields.text_area :content, rows: 6, required: true, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 font-mono text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-fuchsia-400/40 focus:ring-4 focus:ring-fuchsia-400/10", placeholder: "Content" %>
                      <%= prompt_fields.label :content, "Prompt content", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400 transition-all duration-300 peer-placeholder-shown:top-4 peer-placeholder-shown:text-sm peer-placeholder-shown:text-slate-500 peer-focus:top-2 peer-focus:text-xs peer-focus:text-fuchsia-200" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </template>
        </div>
      </div>

      <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center">
        <%= form.submit "Create Bundle", data: { bundle_form_target: "submit" }, class: "inline-flex w-full items-center justify-center rounded-2xl bg-gradient-to-r from-fuchsia-500 via-pink-500 to-cyan-400 px-4 py-3 text-sm font-semibold text-black shadow-[0_0_30px_rgba(217,70,239,0.25)] hover:shadow-[0_0_40px_rgba(34,211,238,0.25)] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed sm:w-auto" %>
        <%= link_to "Cancel", dashboard_path, class: "inline-flex w-full items-center justify-center rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-medium text-slate-100 hover:bg-white/10 transition-all duration-300 sm:w-auto" %>
      </div>
    <% end %>
  </div>
</div>
