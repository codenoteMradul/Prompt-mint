<section class="relative mb-10">
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute inset-x-0 -top-6 h-56 rounded-3xl bg-gradient-to-r from-fuchsia-500/15 via-pink-500/10 to-cyan-400/10 blur-2xl"></div>
    <div class="absolute inset-x-0 top-10 h-56 rounded-3xl bg-gradient-to-r from-[#0f0f14] via-transparent to-[#0f0f14]"></div>
  </div>

  <div class="rounded-3xl border border-white/10 bg-white/[0.04] shadow-[0_0_0_1px_rgba(255,255,255,0.03)] backdrop-blur">
    <div class="h-36 rounded-3xl bg-gradient-to-r from-fuchsia-500/20 via-pink-500/10 to-cyan-400/15"></div>

    <div class="-mt-12 px-6 pb-6 sm:px-8 sm:pb-8">
      <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
        <div class="flex items-start gap-4">
          <div class="relative">
            <% if @user.avatar.attached? %>
              <%= image_tag @user.avatar, class: "h-24 w-24 rounded-full border border-white/10 object-cover shadow-[0_0_0_6px_rgba(15,15,20,1)]" %>
            <% else %>
              <div class="h-24 w-24 rounded-full border border-white/10 bg-gradient-to-br from-fuchsia-500/30 via-pink-500/20 to-cyan-400/20 shadow-[0_0_0_6px_rgba(15,15,20,1)]"></div>
            <% end %>
          </div>

          <div class="pt-2">
            <p class="text-xs font-medium tracking-wide text-slate-400">Creator profile</p>
            <h1 class="mt-2 text-3xl font-semibold tracking-tight text-white sm:text-4xl"><%= @user.name %></h1>

            <div class="mt-3 flex flex-wrap items-center gap-2 text-sm text-slate-400">
              <% if @user.country.present? %>
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"><%= @user.country %></span>
              <% end %>
              <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200">
                Member since <%= @user.created_at.to_date.strftime("%b %Y") %>
              </span>
              <% if @user.years_of_experience.present? %>
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"><%= @user.years_of_experience %> yrs exp</span>
              <% end %>
              <% if @user.rank_position.present? %>
                <span class="rounded-full border border-fuchsia-500/20 bg-fuchsia-500/10 px-3 py-1 text-xs text-fuchsia-100 shadow-[0_0_20px_rgba(217,70,239,0.15)]">
                  Rank #<%= @user.rank_position %> on PromptMint
                </span>
                <span class="rounded-full border border-cyan-400/20 bg-cyan-400/10 px-3 py-1 text-xs text-cyan-100 shadow-[0_0_20px_rgba(34,211,238,0.12)]">
                  Score <%= @user.ranking_score.to_f.round(2) %>
                </span>
              <% end %>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <% if logged_in? %>
            <%= link_to "Message", conversation_path(@user), class: "rounded-2xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-medium text-slate-100 hover:bg-white/10 transition-all duration-300" %>
          <% else %>
            <%= link_to "Message", login_path, class: "rounded-2xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-medium text-slate-100 hover:bg-white/10 transition-all duration-300" %>
          <% end %>

          <% if !(logged_in? && current_user.id == @user.id) %>
            <%= link_to "View Bundles", "#bundles", class: "rounded-2xl bg-gradient-to-r from-fuchsia-500 via-pink-500 to-cyan-400 px-4 py-2.5 text-sm font-semibold text-black shadow-[0_0_30px_rgba(217,70,239,0.20)] hover:shadow-[0_0_40px_rgba(34,211,238,0.20)] transition-all duration-300" %>
          <% end %>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-3">
        <div class="lg:col-span-2">
          <p class="text-sm leading-relaxed text-slate-300"><%= @user.profile_description.presence || "No bio yet." %></p>
        </div>

        <div class="grid grid-cols-2 gap-3 sm:grid-cols-4 lg:grid-cols-2">
          <% creator_badge = nil %>
          <% if @user.rank_position.to_i > 0 && @user.rank_position.to_i <= 3 %>
            <% creator_badge = "Top Creator" %>
          <% elsif (@average_rating || 0).to_f >= 4.5 && @total_bundles_sold.to_i > 20 %>
            <% creator_badge = "Elite Creator" %>
          <% elsif @user.rank_position.to_i > 0 && @user.rank_position.to_i <= 20 %>
            <% creator_badge = "Rising Creator" %>
          <% end %>

          <% if creator_badge.present? %>
            <div class="col-span-2 rounded-2xl border border-white/10 bg-black/20 px-4 py-3 sm:col-span-4 lg:col-span-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-xs text-slate-400">Badge</div>
                  <div class="mt-1 text-lg font-semibold text-white"><%= creator_badge %></div>
                </div>
                <div class="h-10 w-10 rounded-2xl border border-white/10 bg-gradient-to-br from-fuchsia-500/20 via-pink-500/10 to-cyan-400/10"></div>
              </div>
            </div>
          <% end %>

          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <div class="text-xs text-slate-400">Avg rating</div>
            <div class="mt-1 flex items-center gap-2">
              <div class="flex items-center gap-0.5">
                <% rating = (@average_rating || 0).to_f %>
                <% 5.times do |i| %>
                  <% filled = rating >= (i + 1) %>
                  <span class="<%= filled ? "text-amber-300" : "text-white/20" %>">★</span>
                <% end %>
              </div>
              <span class="text-sm font-semibold text-white"><%= (@average_rating || 0).round(1) %></span>
            </div>
          </div>

          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <div class="text-xs text-slate-400">Reviews</div>
            <div class="mt-1 text-lg font-semibold text-white"><%= @review_count %></div>
          </div>

          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <div class="text-xs text-slate-400">Bundles</div>
            <div class="mt-1 text-lg font-semibold text-white"><%= @total_bundles %></div>
          </div>

          <div class="rounded-2xl border border-white/10 bg-black/20 px-4 py-3">
            <div class="text-xs text-slate-400">Bundles sold</div>
            <div class="mt-1 text-lg font-semibold text-white"><%= @total_bundles_sold %></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="mb-10">
  <div class="mb-4 flex items-center justify-between">
    <h2 class="text-sm font-semibold tracking-wide text-white">Reviews</h2>
    <span class="text-xs text-slate-400"><%= @review_count %> total</span>
  </div>

  <% if @can_review %>
    <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.03)] backdrop-blur">
      <h3 class="text-sm font-semibold text-white">Leave a review</h3>
      <p class="mt-1 text-sm text-slate-400">Only verified buyers can leave a review.</p>

      <%= form_with url: user_reviews_path(@user), scope: :review, class: "mt-5" do |form| %>
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-300">Rating</span>
          <div class="flex items-center gap-1" data-controller="star-rating">
            <% 1.upto(5) do |value| %>
              <%= form.radio_button :rating, value, class: "sr-only", required: true, id: "review_rating_#{value}", data: { star_rating_target: "input", action: "change->star-rating#render" } %>
              <%= form.label :rating, "★", value: value, for: "review_rating_#{value}", data: { value: value, star_rating_target: "star", action: "click->star-rating#select" }, class: "cursor-pointer text-2xl text-white/20 transition-colors duration-200 hover:text-amber-200" %>
            <% end %>
          </div>
        </div>

        <div class="relative mt-4">
          <%= form.text_area :comment, rows: 4, class: "peer w-full rounded-2xl border border-white/10 bg-black/30 px-4 pb-3 pt-6 text-sm text-white placeholder-transparent outline-none transition-all duration-300 focus:border-fuchsia-400/40 focus:ring-4 focus:ring-fuchsia-400/10", placeholder: "Comment" %>
          <%= form.label :comment, "Comment (optional)", class: "pointer-events-none absolute left-4 top-2 text-xs font-medium tracking-wide text-slate-400" %>
        </div>

        <div class="mt-5">
          <%= form.submit "Submit review", class: "inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-fuchsia-500 via-pink-500 to-cyan-400 px-5 py-3 text-sm font-semibold text-black shadow-[0_0_30px_rgba(217,70,239,0.25)] hover:shadow-[0_0_40px_rgba(34,211,238,0.25)] transition-all duration-300" %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.03)] backdrop-blur">
      <p class="text-sm text-slate-300">Only verified buyers can leave a review.</p>
    </div>
  <% end %>

  <% if @reviews.any? %>
    <div class="mt-4 space-y-3">
      <% @reviews.each do |review| %>
        <div class="rounded-2xl border border-white/10 bg-black/20 p-5">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="flex items-center gap-2">
                <div class="text-sm font-semibold text-white"><%= review.reviewer.name %></div>
                <% if @verified_buyer_ids.include?(review.reviewer_id) %>
                  <span class="rounded-full bg-emerald-500/10 px-2.5 py-1 text-xs text-emerald-200">Verified Buyer</span>
                <% end %>
              </div>
              <div class="mt-1 text-xs text-slate-500"><%= review.created_at.strftime("%b %d, %Y") %></div>
            </div>
            <div class="flex items-center gap-0.5">
              <% 5.times do |i| %>
                <% filled = review.rating.to_i >= (i + 1) %>
                <span class="<%= filled ? "text-amber-300" : "text-white/20" %>">★</span>
              <% end %>
            </div>
          </div>

          <% if review.comment.present? %>
            <p class="mt-3 text-sm text-slate-300"><%= review.comment %></p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</section>

<section id="bundles">
  <div class="mb-4 flex items-center justify-between">
    <h2 class="text-sm font-semibold tracking-wide text-white">Bundles</h2>
    <span class="text-xs text-slate-400"><%= @bundles.size %> total</span>
  </div>

  <% if @bundles.empty? %>
    <div class="rounded-2xl border border-white/10 bg-white/[0.04] p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.03)] backdrop-blur">
      <p class="text-sm text-slate-300">No bundles yet.</p>
    </div>
  <% else %>
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      <% @bundles.each do |bundle| %>
        <% owner = logged_in? && current_user.id == bundle.user_id %>
        <% unlocked = owner || (@purchased_bundle_ids.include?(bundle.id)) %>
        <%= render "shared/bundle_card", bundle:, unlocked:, owner:, show_removed_badge: owner %>
      <% end %>
    </div>
  <% end %>
</section>
